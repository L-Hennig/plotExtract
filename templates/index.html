<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlotExtract Interface</title>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background: #f5f5f5; 
        }
        h1 { color: #333; }
        .container { max-width: 1400px; margin: 0 auto; }
        .panel {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .panel h2 { margin-top: 0; color: #444; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        select, input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .csv-label {
            padding: 10px;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Consolas', monospace;
            font-size: 13px;
            color: #555;
        }
        .csv-label.exists { border-color: #28a745; background: #e8f5e9; }
        .csv-label.missing { border-color: #dc3545; background: #ffebee; color: #c62828; }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-large {
            padding: 16px 32px;
            font-size: 16px;
            font-weight: bold;
        }
        .btn:hover { opacity: 0.9; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .row { display: flex; gap: 20px; flex-wrap: wrap; }
        .col { flex: 1; min-width: 300px; }
        .checkbox-group {
            display: flex;
            gap: 20px;
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-weight: normal;
        }
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
        .axis-inputs { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
            margin-top: 10px;
        }
        .axis-inputs.disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        .summary-stats {
            background: #f0f7ff;
            border: 1px solid #b3d4fc;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .summary-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }
        .summary-row:last-child {
            margin-bottom: 0;
        }
        .summary-label {
            font-weight: bold;
            color: #333;
            margin-right: 8px;
            min-width: 140px;
        }
        .summary-value {
            color: #0066cc;
            font-weight: 500;
        }
        .summary-value.yes {
            color: #28a745;
        }
        .summary-value.no {
            color: #dc3545;
        }
        .output-section { margin-top: 20px; }
        .output-images { 
            display: flex; 
            flex-wrap: nowrap; 
            gap: 15px; 
            justify-content: center;
            align-items: flex-start;
        }
        .image-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            min-width: 0;
        }
        .image-card img {
            width: 100%;
            max-height: 600px;
            object-fit: contain;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }
        .image-card img:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .image-label {
            margin-top: 8px;
            font-size: 13px;
            color: #666;
            font-weight: bold;
            text-align: center;
        }
        .file-list { list-style: none; padding: 0; }
        .file-list li {
            padding: 10px 12px;
            background: #f8f9fa;
            margin-bottom: 5px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .file-list li:hover { background: #e9ecef; }
        .file-list .file-label {
            font-size: 11px;
            color: #666;
            background: #e0e0e0;
            padding: 2px 8px;
            border-radius: 3px;
        }
        .console {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Consolas', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .file-content {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Consolas', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            border: 1px solid #ddd;
        }
        .loading { color: #007bff; font-style: italic; }
        .error { color: #dc3545; }
        .success { color: #28a745; }
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal img { max-width: 95%; max-height: 95%; }
        .modal.active { display: flex; }
        .tabs { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 15px; }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            color: #666;
        }
        .tab.active { color: #007bff; border-bottom: 2px solid #007bff; margin-bottom: -2px; }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-indicator.exists { background: #28a745; }
        .status-indicator.missing { background: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ”¬ PlotExtract Interface</h1>
        
        <!-- Selection Panel -->
        <div class="panel">
            <h2>1. Select Input & Configure</h2>
            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label for="imageSelect">Select Image:</label>
                        <select id="imageSelect" onchange="onImageSelect()">
                            <option value="">-- Choose an image --</option>
                            {% for image in images %}
                            <option value="{{ image }}">{{ image }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="promptSelect">Select Prompt:</label>
                        <select id="promptSelect" onchange="onPromptSelect()">
                            {% for prompt in prompts %}
                            <option value="{{ prompt }}">{{ prompt }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col">
                    <!-- Preview selected image -->
                    <div id="imagePreview" style="display: none;">
                        <label><strong>Preview:</strong></label>
                        <img id="previewImg" src="" style="max-width: 400px; max-height: 250px; display: block; margin-top: 10px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;" onclick="openModal(this.src)">
                    </div>
                </div>
            </div>
            
            <!-- CSV Info -->
            <div class="row" style="margin-top: 15px;">
                <div class="col">
                    <div class="form-group">
                        <label>Original CSV (auto-detected):</label>
                        <div id="originalCsvLabel" class="csv-label">Select an image first</div>
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label>Extracted Data (after extraction):</label>
                        <div id="extractedCsvLabel" class="csv-label">Will be created after extraction</div>
                    </div>
                </div>
            </div>
            
            <!-- Options -->
            <div class="checkbox-group">
                <label>
                    <input type="checkbox" id="runInterpolation" onchange="toggleAxisInputs()">
                    Run Interpolation Comparison
                </label>
                <label>
                    <input type="checkbox" id="runPointwise" onchange="toggleAxisInputs()">
                    Run Pointwise Comparison
                </label>
            </div>
            
            <!-- Axis Inputs -->
            <div id="axisSection">
                <label><strong>Axis Ranges (for comparison):</strong></label>
                <div class="axis-inputs disabled" id="axisInputs">
                    <div class="form-group">
                        <label for="leftX">Left X:</label>
                        <input type="number" id="leftX" value="0" step="any">
                    </div>
                    <div class="form-group">
                        <label for="rightX">Right X:</label>
                        <input type="number" id="rightX" value="24" step="any">
                    </div>
                    <div class="form-group">
                        <label for="bottomY">Bottom Y:</label>
                        <input type="number" id="bottomY" value="0" step="any">
                    </div>
                    <div class="form-group">
                        <label for="topY">Top Y:</label>
                        <input type="number" id="topY" value="16" step="any">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Processing Panel -->
        <div class="panel">
            <h2>2. Processing</h2>
            <div style="text-align: center; margin-bottom: 15px;">
                <button class="btn btn-primary btn-large" onclick="runAll()" id="btnRunAll">
                    ðŸš€ Run Plot Extraction (and Comparison)
                </button>
                <p style="color: #666; margin-top: 10px;">
                    This will extract data from the image. If checkboxes are enabled, it will also run comparisons.
                </p>
            </div>
            <div id="consoleOutput" class="console">Ready. Select an image and click "Run Plot Extraction" to begin.</div>
        </div>
        
        <!-- Results Panel -->
        <div class="panel">
            <h2>3. Results</h2>
            <div class="tabs">
                <button class="tab active" onclick="showTab('images')">Images</button>
                <button class="tab" onclick="showTab('stats')">Statistics</button>
                <button class="tab" onclick="showTab('data')">Data Files</button>
            </div>
            
            <div id="tab-images" class="tab-content">
                <!-- Summary Stats Display -->
                <div id="summaryStats" class="summary-stats" style="display: none;">
                    <div class="summary-row">
                        <span class="summary-label">Validation Result:</span>
                        <span id="summaryValidation" class="summary-value">-</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Validation Reason:</span>
                        <span id="summaryValidationReason" class="summary-value">-</span>
                    </div>
                    <div id="interpolationStats" class="summary-row" style="display: none;">
                        <span class="summary-label">Interpolation MAE:</span>
                        <span id="summaryInterpolationMAE" class="summary-value">-</span>
                    </div>
                    <div id="pointwiseStats" style="display: none;">
                        <div class="summary-row">
                            <span class="summary-label">MAE X:</span>
                            <span id="summaryMAEX" class="summary-value">-</span>
                            <span class="summary-label" style="margin-left: 20px;">MAE Y:</span>
                            <span id="summaryMAEY" class="summary-value">-</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Precision:</span>
                            <span id="summaryPrecision" class="summary-value">-</span>
                            <span class="summary-label" style="margin-left: 20px;">Recall:</span>
                            <span id="summaryRecall" class="summary-value">-</span>
                        </div>
                    </div>
                </div>
                
                <div id="outputImages" class="output-images">
                    <p style="color: #666;">Select an image and run extraction to see results.</p>
                </div>
            </div>
            
            <div id="tab-stats" class="tab-content" style="display: none;">
                <ul id="outputStats" class="file-list">
                    <li style="color: #666;">No statistics files yet.</li>
                </ul>
                <div id="statsContent" class="file-content" style="display: none; margin-top: 15px;"></div>
            </div>
            
            <div id="tab-data" class="tab-content" style="display: none;">
                <ul id="outputData" class="file-list">
                    <li style="color: #666;">No data files yet.</li>
                </ul>
                <div id="dataContent" class="file-content" style="display: none; margin-top: 15px;"></div>
            </div>
        </div>
    </div>
    
    <!-- Image Modal -->
    <div id="imageModal" class="modal" onclick="closeModal()">
        <img id="modalImg" src="">
    </div>
    
    <script>
        function onImageSelect() {
            const imagePath = document.getElementById('imageSelect').value;
            const preview = document.getElementById('imagePreview');
            const previewImg = document.getElementById('previewImg');
            
            if (imagePath) {
                previewImg.src = '/plots/' + imagePath;
                preview.style.display = 'block';
                updateCsvInfo();
                loadOutputFiles();
            } else {
                preview.style.display = 'none';
                document.getElementById('originalCsvLabel').textContent = 'Select an image first';
                document.getElementById('originalCsvLabel').className = 'csv-label';
                document.getElementById('extractedCsvLabel').textContent = 'Will be created after extraction';
                document.getElementById('extractedCsvLabel').className = 'csv-label';
            }
        }
        
        function onPromptSelect() {
            updateCsvInfo();
        }
        
        function updateCsvInfo() {
            const imagePath = document.getElementById('imageSelect').value;
            const promptFile = document.getElementById('promptSelect').value;
            
            if (!imagePath) return;
            
            fetch('/check_csv', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image_path: imagePath, prompt_file: promptFile })
            })
            .then(res => res.json())
            .then(data => {
                // Update original CSV label
                const origLabel = document.getElementById('originalCsvLabel');
                origLabel.textContent = data.original.path;
                origLabel.className = 'csv-label ' + (data.original.exists ? 'exists' : 'missing');
                
                // Update extracted CSV label
                const extLabel = document.getElementById('extractedCsvLabel');
                if (data.extracted.exists) {
                    extLabel.textContent = data.extracted.path;
                    extLabel.className = 'csv-label exists';
                } else {
                    // Show expected path
                    const promptName = promptFile.replace('prompt_', 'p').replace('.py', '');
                    const imageName = imagePath.split('/').pop();
                    extLabel.textContent = `${data.image_dir}/${imageName}.${promptName}.mistral.out_data (will be created)`;
                    extLabel.className = 'csv-label missing';
                }
            });
        }
        
        function toggleAxisInputs() {
            const interpolation = document.getElementById('runInterpolation').checked;
            const pointwise = document.getElementById('runPointwise').checked;
            const axisInputs = document.getElementById('axisInputs');
            
            if (interpolation || pointwise) {
                axisInputs.classList.remove('disabled');
            } else {
                axisInputs.classList.add('disabled');
            }
        }
        
        function loadOutputFiles() {
            const imagePath = document.getElementById('imageSelect').value;
            const promptFile = document.getElementById('promptSelect').value;
            
            if (!imagePath) return;
            
            fetch('/get_outputs', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image_path: imagePath, prompt_file: promptFile })
            })
            .then(res => res.json())
            .then(data => {
                updateOutputDisplay(data.outputs);
            });
        }
        
        function updateOutputDisplay(outputs) {
            // Update images with labels - only show comparison, interpolation, pointwise
            const imagesDiv = document.getElementById('outputImages');
            if (outputs.images && outputs.images.length > 0) {
                // Filter to only show comparison, interpolation, and pointwise images
                const filteredImages = outputs.images.filter(img => 
                    img.filename.startsWith('comparison_') || 
                    img.filename.startsWith('interpolated_') || 
                    img.filename.startsWith('pointwise_')
                );
                
                if (filteredImages.length > 0) {
                    imagesDiv.innerHTML = filteredImages.map(img => 
                        `<div class="image-card">
                            <img src="/plots/${img.path}" onclick="openModal('/plots/${img.path}')" title="${img.filename}">
                            <div class="image-label">${img.label}</div>
                        </div>`
                    ).join('');
                } else {
                    imagesDiv.innerHTML = '<p style="color: #666;">No comparison images yet. Run extraction first.</p>';
                }
            } else {
                imagesDiv.innerHTML = '<p style="color: #666;">No output images yet.</p>';
            }
            
            // Update summary statistics display
            const summaryDiv = document.getElementById('summaryStats');
            const summary = outputs.summary || {};
            
            if (summary.validation_result) {
                summaryDiv.style.display = 'block';
                
                // Validation result with color
                const valResult = document.getElementById('summaryValidation');
                valResult.textContent = summary.validation_result;
                valResult.className = 'summary-value ' + (summary.validation_result === 'Yes' ? 'yes' : 'no');
                
                // Validation reason
                document.getElementById('summaryValidationReason').textContent = summary.validation_reason || 'N/A';
                
                // Interpolation stats
                const interpStats = document.getElementById('interpolationStats');
                if (summary.interpolation_mae !== null && summary.interpolation_mae !== undefined) {
                    interpStats.style.display = 'flex';
                    document.getElementById('summaryInterpolationMAE').textContent = summary.interpolation_mae.toFixed(4);
                } else {
                    interpStats.style.display = 'none';
                }
                
                // Pointwise stats
                const pointwiseStats = document.getElementById('pointwiseStats');
                if (summary.precision !== null && summary.precision !== undefined) {
                    pointwiseStats.style.display = 'block';
                    document.getElementById('summaryMAEX').textContent = summary.pointwise_mae_x || '-';
                    document.getElementById('summaryMAEY').textContent = summary.pointwise_mae_y || '-';
                    document.getElementById('summaryPrecision').textContent = summary.precision || '-';
                    document.getElementById('summaryRecall').textContent = summary.recall || '-';
                } else {
                    pointwiseStats.style.display = 'none';
                }
            } else {
                summaryDiv.style.display = 'none';
            }
            
            // Update stats with labels
            const statsList = document.getElementById('outputStats');
            if (outputs.stats && outputs.stats.length > 0) {
                statsList.innerHTML = outputs.stats.map(f => 
                    `<li onclick="loadFileContent('${f.path}', 'statsContent')">
                        <span>${f.filename}</span>
                        <span class="file-label">${f.label}</span>
                    </li>`
                ).join('');
            } else {
                statsList.innerHTML = '<li style="color: #666;">No statistics files yet.</li>';
            }
            
            // Update data with labels
            const dataList = document.getElementById('outputData');
            if (outputs.data && outputs.data.length > 0) {
                dataList.innerHTML = outputs.data.map(f => 
                    `<li onclick="loadFileContent('${f.path}', 'dataContent')">
                        <span>${f.filename}</span>
                        <span class="file-label">${f.label}</span>
                    </li>`
                ).join('');
            } else {
                dataList.innerHTML = '<li style="color: #666;">No data files yet.</li>';
            }
        }
        
        function loadFileContent(filePath, targetId) {
            const target = document.getElementById(targetId);
            target.style.display = 'block';
            target.innerHTML = '<span class="loading">Loading...</span>';
            
            fetch('/read_file', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ file_path: filePath })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    target.textContent = data.content;
                } else {
                    target.innerHTML = `<span class="error">Error: ${data.error}</span>`;
                }
            });
        }
        
        function runAll() {
            const imagePath = document.getElementById('imageSelect').value;
            const promptFile = document.getElementById('promptSelect').value;
            
            if (!imagePath) {
                alert('Please select an image first.');
                return;
            }
            
            const btn = document.getElementById('btnRunAll');
            btn.disabled = true;
            btn.textContent = 'â³ Running...';
            
            // Clear console
            const consoleOutput = document.getElementById('consoleOutput');
            consoleOutput.textContent = 'Starting tasks...\n';
            
            fetch('/run_all', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    image: imagePath,
                    prompt: promptFile,
                    runInterpolation: document.getElementById('runInterpolation').checked,
                    runPointwise: document.getElementById('runPointwise').checked,
                    leftX: parseFloat(document.getElementById('leftX').value) || 0,
                    rightX: parseFloat(document.getElementById('rightX').value) || 100,
                    bottomY: parseFloat(document.getElementById('bottomY').value) || 0,
                    topY: parseFloat(document.getElementById('topY').value) || 100
                })
            })
            .then(res => res.json())
            .then(data => {
                btn.disabled = false;
                btn.textContent = 'ðŸš€ Run Plot Extraction (and Comparison)';
                
                // Update console
                consoleOutput.textContent = data.console;
                consoleOutput.scrollTop = consoleOutput.scrollHeight;
                
                // Update outputs
                if (data.outputs) {
                    updateOutputDisplay(data.outputs);
                }
                
                // Update CSV info
                updateCsvInfo();
                
                // Show images tab if successful
                if (data.success) {
                    showTab('images');
                }
            })
            .catch(err => {
                btn.disabled = false;
                btn.textContent = 'ðŸš€ Run Plot Extraction (and Comparison)';
                consoleOutput.textContent += '\n\n[ERROR] ' + err;
            });
        }
        
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            
            // Show selected tab
            document.getElementById('tab-' + tabName).style.display = 'block';
            // Find and activate the correct tab button
            document.querySelectorAll('.tab').forEach(t => {
                if (t.textContent.toLowerCase().includes(tabName.substring(0, 4))) {
                    t.classList.add('active');
                }
            });
        }
        
        function openModal(src) {
            document.getElementById('modalImg').src = src;
            document.getElementById('imageModal').classList.add('active');
        }
        
        function closeModal() {
            document.getElementById('imageModal').classList.remove('active');
        }
        
        // Close modal with Escape key
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') closeModal();
        });
    </script>
</body>
</html>
